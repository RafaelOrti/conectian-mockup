<div class="provider-payments-page" [class.no-navbar]="!showNavbar">
  <app-navbar 
    *ngIf="showNavbar"
    [userRole]="'PROVIDER'" 
    [userName]="'TechSolutions AI'"
    [notificationCount]="5"
  ></app-navbar>
  
  <div class="container">
    <!-- Page Header -->
    <div class="page-header">
      <div class="header-left">
        <div class="header-icon">
          <i class="pi pi-wallet"></i>
        </div>
        <div class="header-text">
          <h1>Pagos y Facturación</h1>
          <p class="subtitle">Gestiona tus ingresos, retiros y facturas</p>
        </div>
      </div>
      <p-button 
        label="Solicitar Retiro" 
        icon="pi pi-download" 
        (click)="openWithdrawDialog()"
        styleClass="withdraw-button"
      ></p-button>
    </div>

    <!-- Balance Cards -->
    <div class="balance-cards-grid">
      <p-card styleClass="balance-card main-balance">
        <div class="card-content">
          <div class="card-icon">
            <i class="pi pi-wallet"></i>
          </div>
          <div class="card-info">
            <span class="card-label">Saldo Disponible</span>
            <span class="card-amount">{{ formatCurrency(availableBalance) }}</span>
            <span class="card-sublabel">Listo para retirar</span>
          </div>
        </div>
        <div class="card-action">
          <p-button 
            label="Retirar Fondos" 
            icon="pi pi-arrow-circle-down"
            styleClass="p-button-sm"
            (click)="openWithdrawDialog()"
          ></p-button>
        </div>
      </p-card>

      <p-card styleClass="balance-card pending-balance">
        <div class="card-content">
          <div class="card-icon">
            <i class="pi pi-clock"></i>
          </div>
          <div class="card-info">
            <span class="card-label">Pendiente de Cobro</span>
            <span class="card-amount">{{ formatCurrency(pendingAmount) }}</span>
            <span class="card-sublabel">En proceso</span>
          </div>
        </div>
      </p-card>

      <p-card styleClass="balance-card total-earnings">
        <div class="card-content">
          <div class="card-icon">
            <i class="pi pi-chart-line"></i>
          </div>
          <div class="card-info">
            <span class="card-label">Ingresos Totales</span>
            <span class="card-amount">{{ formatCurrency(totalEarnings) }}</span>
            <span class="card-sublabel">Histórico</span>
          </div>
        </div>
      </p-card>
    </div>

    <!-- Earnings Chart -->
    <p-card styleClass="chart-card">
      <ng-template pTemplate="header">
        <div class="card-header">
          <div class="header-content">
            <i class="pi pi-chart-bar"></i>
            <h3>Evolución de Ingresos</h3>
          </div>
          <p-button 
            icon="pi pi-download" 
            styleClass="p-button-text p-button-sm"
            pTooltip="Exportar datos"
          ></p-button>
        </div>
      </ng-template>
      <div class="chart-container">
        <p-chart 
          type="line" 
          [data]="chartData" 
          [options]="chartOptions"
          [style]="{'height': '300px'}"
        ></p-chart>
      </div>
    </p-card>

    <!-- Transactions Table -->
    <p-card styleClass="transactions-card">
      <ng-template pTemplate="header">
        <div class="card-header">
          <div class="header-content">
            <i class="pi pi-list"></i>
            <h3>Transacciones Recientes</h3>
          </div>
          <div class="header-actions">
            <p-button 
              label="Filtrar" 
              icon="pi pi-filter" 
              styleClass="p-button-outlined p-button-sm"
            ></p-button>
            <p-button 
              label="Exportar" 
              icon="pi pi-file-excel" 
              styleClass="p-button-outlined p-button-sm p-button-success"
            ></p-button>
          </div>
        </div>
      </ng-template>

      <p-table 
        [value]="transactions" 
        [paginator]="true" 
        [rows]="10"
        [tableStyle]="{'min-width': '50rem'}"
        styleClass="transactions-table"
      >
        <ng-template pTemplate="header">
          <tr>
            <th pSortableColumn="id">
              ID <p-sortIcon field="id"></p-sortIcon>
            </th>
            <th pSortableColumn="date">
              Fecha <p-sortIcon field="date"></p-sortIcon>
            </th>
            <th>Descripción</th>
            <th>Cliente</th>
            <th pSortableColumn="amount" style="text-align: right;">
              Monto <p-sortIcon field="amount"></p-sortIcon>
            </th>
            <th>Estado</th>
            <th style="text-align: center;">Factura</th>
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-transaction>
          <tr>
            <td>
              <span class="transaction-id">{{ transaction.id }}</span>
            </td>
            <td>{{ transaction.date }}</td>
            <td>
              <div class="transaction-description">
                {{ transaction.description }}
              </div>
            </td>
            <td>
              <div class="client-info">
                <span class="client-name">{{ transaction.client }}</span>
              </div>
            </td>
            <td style="text-align: right;">
              <span class="transaction-amount positive">
                +{{ formatCurrency(transaction.amount) }}
              </span>
            </td>
            <td>
              <p-tag 
                [value]="transaction.status === 'completed' ? 'Completado' : transaction.status === 'pending' ? 'Pendiente' : 'Procesando'" 
                [severity]="getStatusSeverity(transaction.status)"
                [icon]="transaction.status === 'completed' ? 'pi pi-check' : 'pi pi-clock'"
              ></p-tag>
            </td>
            <td style="text-align: center;">
              <p-button 
                icon="pi pi-download" 
                styleClass="p-button-rounded p-button-text"
                pTooltip="Descargar factura"
                tooltipPosition="left"
                (click)="downloadInvoice(transaction)"
                [disabled]="transaction.status !== 'completed'"
              ></p-button>
            </td>
          </tr>
        </ng-template>
        <ng-template pTemplate="emptymessage">
          <tr>
            <td colspan="7" style="text-align: center; padding: 3rem;">
              <div class="empty-state">
                <i class="pi pi-inbox" style="font-size: 3rem; color: #6b7280;"></i>
                <p>No hay transacciones disponibles</p>
              </div>
            </td>
          </tr>
        </ng-template>
      </p-table>
    </p-card>

    <!-- Bank Account Configuration Card -->
    <p-card styleClass="bank-config-card">
      <ng-template pTemplate="header">
        <div class="card-header">
          <div class="header-content">
            <i class="pi pi-building"></i>
            <h3>Configuración Bancaria</h3>
          </div>
        </div>
      </ng-template>

      <div class="bank-info">
        <div class="bank-details">
          <div class="detail-item">
            <i class="pi pi-building"></i>
            <div class="detail-content">
              <span class="detail-label">Banco</span>
              <span class="detail-value">Banco Santander</span>
            </div>
          </div>
          <div class="detail-item">
            <i class="pi pi-id-card"></i>
            <div class="detail-content">
              <span class="detail-label">IBAN</span>
              <span class="detail-value">ES91 2100 0418 4502 0005 1332</span>
            </div>
          </div>
          <div class="detail-item">
            <i class="pi pi-user"></i>
            <div class="detail-content">
              <span class="detail-label">Titular</span>
              <span class="detail-value">TechSolutions AI S.L.</span>
            </div>
          </div>
        </div>
        <div class="bank-actions">
          <p-button 
            label="Actualizar Cuenta" 
            icon="pi pi-pencil" 
            styleClass="p-button-outlined"
          ></p-button>
        </div>
      </div>
    </p-card>
  </div>

  <!-- Withdraw Dialog -->
  <p-dialog 
    [(visible)]="showWithdrawDialog" 
    header="Solicitar Retiro de Fondos" 
    [modal]="true"
    [style]="{width: '550px'}"
    [draggable]="false"
    [resizable]="false"
  >
    <div class="withdraw-dialog-content">
      <div class="withdraw-info">
        <div class="info-item">
          <i class="pi pi-wallet"></i>
          <div class="info-content">
            <span class="info-label">Saldo Disponible</span>
            <span class="info-value">{{ formatCurrency(availableBalance) }}</span>
          </div>
        </div>
      </div>

      <div class="p-fluid">
        <div class="field">
          <label for="amount">Cantidad a Retirar</label>
          <div class="p-inputgroup">
            <span class="p-inputgroup-addon">€</span>
            <input 
              id="amount" 
              type="number" 
              pInputText 
              placeholder="0.00"
              [max]="availableBalance"
            />
          </div>
          <small class="field-help">Mínimo: €100.00 | Máximo: {{ formatCurrency(availableBalance) }}</small>
        </div>

        <div class="field">
          <label for="bank">Cuenta Bancaria</label>
          <input 
            id="bank" 
            type="text" 
            pInputText 
            value="ES91 2100 0418 4502 0005 1332"
            disabled
          />
        </div>

        <div class="withdrawal-notice">
          <i class="pi pi-info-circle"></i>
          <div class="notice-content">
            <strong>Tiempo de procesamiento</strong>
            <p>Los retiros se procesan en 2-3 días hábiles.</p>
          </div>
        </div>
      </div>
    </div>
    
    <ng-template pTemplate="footer">
      <p-button 
        label="Cancelar" 
        icon="pi pi-times" 
        (click)="showWithdrawDialog = false" 
        styleClass="p-button-text"
      ></p-button>
      <p-button 
        label="Confirmar Retiro" 
        icon="pi pi-check" 
        (click)="showWithdrawDialog = false"
      ></p-button>
    </ng-template>
  </p-dialog>
</div>
