<div class="leads-crm-page">
  <app-navbar 
    [userRole]="'PROVIDER'" 
    [userName]="'María González'" 
    [notificationCount]="2"
    [messageCount]="3"
  ></app-navbar>
  
  <div class="container">
    <header class="page-header">
      <div class="header-content">
        <h1>Bandeja de Leads y Proyectos</h1>
        <div class="search-filters">
          <span class="p-input-icon-left">
            <i class="pi pi-search"></i>
            <input type="text" pInputText placeholder="Buscar leads, empresas..." class="search-input" />
          </span>
          <p-button label="Fecha" icon="pi pi-calendar" styleClass="p-button-outlined p-button-secondary"></p-button>
          <p-button label="Prioridad" icon="pi pi-sort-amount-down" styleClass="p-button-outlined p-button-secondary"></p-button>
          <p-button label="Fuente" icon="pi pi-filter" styleClass="p-button-outlined p-button-secondary"></p-button>
        </div>
      </div>
    </header>
    
    <!-- Tabs para filtrar vista -->
    <div class="view-tabs">
      <p-selectButton [options]="viewOptions" [(ngModel)]="activeView" optionLabel="label" optionValue="value" styleClass="glass-select-button"></p-selectButton>
      <div class="metrics-summary">
        <span class="metric">
          <span class="label">Conversión:</span>
          <span class="value">{{ metrics.conversionRate }}%</span>
        </span>
        <span class="metric">
          <span class="label">Tiempo prom:</span>
          <span class="value">{{ metrics.avgTime }} días</span>
        </span>
      </div>
    </div>
    
    <!-- Kanban Board -->
    <div class="kanban-board">
      <div *ngFor="let column of columns" class="kanban-column" [attr.data-color]="column.color">
        <div class="column-header" [class]="'header-' + column.color">
          <h3>{{ column.title }} <span class="count-badge">{{ column.count }}</span></h3>
        </div>
        
        <div class="column-content">
          <div *ngFor="let lead of column.leads" class="lead-item">
            <p-card styleClass="lead-card">
              <ng-template pTemplate="header">
                <div class="card-image-header">
                  <img [src]="lead.logo" [alt]="lead.companyName" class="company-logo-image" />
                  <div class="image-overlay"></div>
                </div>
                <div class="card-header-content">
                  <div class="company-info">
                    <div class="info-text">
                      <h4>{{ lead.companyName }}</h4>
                      <p-tag *ngIf="lead.isProject" value="Proyecto Activo" severity="success" icon="pi pi-rocket"></p-tag>
                    </div>
                  </div>
                  <div class="drag-handle"><i class="pi pi-ellipsis-v"></i></div>
                </div>
              </ng-template>

              <div class="card-body">
                <!-- Priority Badge -->
                <div class="priority-section">
                  <p-tag [value]="lead.priority" [severity]="getPrioritySeverity(lead.priority)" styleClass="priority-tag"></p-tag>
                </div>
                
                <!-- Project Info (si es proyecto) -->
                <div *ngIf="lead.isProject" class="project-info">
                  <h5 class="project-title">{{ lead.projectTitle }}</h5>
                  <div class="info-grid">
                    <div *ngIf="lead.value" class="info-item">
                      <i class="pi pi-money-bill"></i> ${{ lead.value?.toLocaleString() }}
                    </div>
                    <div *ngIf="lead.timeline" class="info-item">
                      <i class="pi pi-clock"></i> {{ lead.timeline }}
                    </div>
                    <div *ngIf="lead.acceptedDate" class="info-item">
                      <i class="pi pi-calendar"></i> {{ lead.acceptedDate }}
                    </div>
                  </div>
                  <div *ngIf="lead.projectStatus" class="status-section">
                    <p-tag [value]="getProjectStatusLabel(lead.projectStatus)" [severity]="getStatusSeverity(lead.projectStatus)"></p-tag>
                  </div>
                </div>
                
                <!-- Lead Info (si es lead normal) -->
                <ng-container *ngIf="!lead.isProject">
                  <div *ngIf="lead.contactDate" class="info-row">
                    <small>Contactado: {{ lead.contactDate }}</small>
                  </div>
                  <div *ngIf="lead.nextFollowUp" class="info-row highlight">
                    <small><i class="pi pi-bell"></i> Próximo: {{ lead.nextFollowUp }}</small>
                  </div>
                  <div *ngIf="lead.proposalSent" class="proposal-section">
                    <small class="success-text"><i class="pi pi-check"></i> Propuesta enviada</small>
                    <div *ngIf="lead.progress" class="progress-container">
                      <p-progressBar [value]="lead.progress" [showValue]="true" styleClass="h-1"></p-progressBar>
                    </div>
                  </div>
                  <div *ngIf="column.id === 'ganado'" class="action-row">
                    <p-button label="Solicitar reseña" styleClass="p-button-text p-button-sm"></p-button>
                  </div>
                  <div *ngIf="lead.followUpDate" class="info-row muted">
                    <small>{{ lead.followUpDate }}</small>
                  </div>
                </ng-container>
              </div>

              <ng-template pTemplate="footer">
                <div class="card-footer-actions">
                  <p-button 
                    *ngIf="lead.isProject && lead.dealRoomId" 
                    label="Abrir Deal Room" 
                    icon="pi pi-external-link" 
                    styleClass="p-button-primary w-full"
                    (click)="openDealRoom(lead.dealRoomId!); $event.stopPropagation()"
                  ></p-button>
                  <div *ngIf="!lead.isProject" class="icon-actions">
                    <p-button icon="pi pi-eye" styleClass="p-button-text p-button-secondary p-button-rounded"></p-button>
                    <p-button icon="pi pi-comments" styleClass="p-button-text p-button-secondary p-button-rounded"></p-button>
                    <p-button icon="pi pi-ellipsis-h" styleClass="p-button-text p-button-secondary p-button-rounded"></p-button>
                  </div>
                </div>
              </ng-template>
            </p-card>
          </div>
          
          <!-- Alert for Nuevo column -->
          <div *ngIf="column.id === 'nuevo' && column.leads.length > 0" class="column-alert">
            <i class="pi pi-clock"></i> Responde en <24h
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
