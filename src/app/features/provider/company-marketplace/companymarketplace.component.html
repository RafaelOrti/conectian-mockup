<div class="company-marketplace-page">
  <app-navbar 
    [userRole]="'PROVIDER'"
    [userName]="'Mar√≠a L√≥pez'"
    [notificationCount]="2"
  ></app-navbar>
  
  <div class="marketplace-layout">
    <!-- Left Sidebar - Filters -->
    <aside class="filters-sidebar">
      <div class="filters-header">
        <div class="filter-icon">
          <i class="pi pi-filter" style="font-size: 1.2rem; color: white;"></i>
        </div>
        <h3>Filtros</h3>
      </div>
      
      <div class="filter-section">
        <label class="filter-label">Sector</label>
        <div class="checkbox-group">
          <div *ngFor="let sector of sectors" class="checkbox-option">
            <p-checkbox 
              name="sector" 
              [value]="sector" 
              [(ngModel)]="selectedSectors" 
              (onChange)="filterCompanies()"
              [label]="sector"
              styleClass="custom-checkbox"
            ></p-checkbox>
          </div>
        </div>
      </div>

      <div class="filter-section">
        <label class="filter-label">Tama√±o de Empresa</label>
        <div class="checkbox-group">
          <div *ngFor="let size of companySizes" class="checkbox-option">
            <p-checkbox 
              name="size" 
              [value]="size.value" 
              [(ngModel)]="selectedCompanySizes" 
              (onChange)="filterCompanies()"
              [label]="size.label"
              styleClass="custom-checkbox"
            ></p-checkbox>
          </div>
        </div>
      </div>

      <div class="filter-section">
        <label class="filter-label">Tecnolog√≠a Base</label>
        <div class="checkbox-group">
          <div *ngFor="let tech of technologies" class="checkbox-option">
            <p-checkbox 
              name="tech" 
              [value]="tech" 
              [(ngModel)]="selectedTechnologies" 
              (onChange)="filterCompanies()"
              [label]="tech"
              styleClass="custom-checkbox"
            ></p-checkbox>
          </div>
        </div>
      </div>

      <div class="filter-section">
        <label class="filter-label">Facturaci√≥n Anual</label>
        <div class="revenue-range">
          <input 
            pInputText
            type="number" 
            [(ngModel)]="minRevenue"
            placeholder="M√≠n"
            class="revenue-input"
          />
          <span class="range-separator">‚Äî</span>
          <input 
            pInputText
            type="number" 
            [(ngModel)]="maxRevenue"
            placeholder="M√°x"
            class="revenue-input"
          />
        </div>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="marketplace-content">
      <!-- Tabs -->
      <div class="tabs">
        <button 
          class="tab"
          [class.active]="activeTab === 'companies'"
          (click)="activeTab = 'companies'"
        >
          Empresas
        </button>
        <button 
          class="tab"
          [class.active]="activeTab === 'use-cases'"
          (click)="activeTab = 'use-cases'"
        >
          Casos de Uso
        </button>
        <button 
          class="tab"
          [class.active]="activeTab === 'rfps'"
          (click)="activeTab = 'rfps'"
        >
          Demandas (RFPs)
        </button>
      </div>

      <!-- Companies Tab -->
      <div *ngIf="activeTab === 'companies'" class="tab-content">
        <div class="content-header">
          <div>
            <h1>EMPRESAS OBJETIVO</h1>
            <div class="sort-controls">
              <span>Ordenar por:</span>
              <select 
                [(ngModel)]="sortBy"
                (change)="sortCompanies()"
                class="sort-select"
              >
                <option value="relevancia">Relevancia</option>
                <option value="nombre">Nombre</option>
                <option value="rfps">N√∫mero de RFPs</option>
              </select>
            </div>
          </div>
          <div class="search-box">
            <span class="p-input-icon-left w-full">
              <i class="pi pi-search"></i>
              <input 
                pInputText
                type="text" 
                [(ngModel)]="searchQuery"
                (input)="filterCompanies()"
                placeholder="Buscar empresas..."
                class="w-full"
              />
            </span>
          </div>
        </div>

        <!-- Companies Grid -->
        <div class="companies-grid">
          <div 
            *ngFor="let company of filteredCompanies"
            class="company-card h-full"
            (click)="viewCompany(company)"
          >
            <app-card class="h-full flex flex-column">
              <!-- Company Image -->
              <div class="company-image">
                <img [src]="company.image" [alt]="company.name" />
                <div class="image-overlay"></div>
              </div>
              
              <div class="company-header">
                <div class="company-logo">{{ company.logo }}</div>
                <div class="company-info">
                  <h3 class="company-name">{{ company.name }}</h3>
                  <div class="company-tags">
                    <span 
                      *ngFor="let tag of company.tags"
                      class="company-tag"
                    >
                      {{ tag }}
                    </span>
                  </div>
                </div>
              </div>

              <div class="company-details flex-grow-1">
                <div class="detail-row">
                  <span class="detail-label">Innovaci√≥n:</span>
                  <span 
                    class="innovation-badge"
                    [class.high]="company.innovationLevel === 'ALTO'"
                    [class.medium]="company.innovationLevel === 'MEDIO'"
                    [class.low]="company.innovationLevel === 'BAJO'"
                  >
                    {{ company.innovationLevel }}
                  </span>
                </div>
                <div class="detail-row">
                  <span class="detail-label">Cloud:</span>
                  <span class="detail-value">{{ company.cloud }}</span>
                </div>
                <div class="detail-row" *ngIf="company.annualRevenue">
                  <span class="detail-label">Facturaci√≥n:</span>
                  <span class="detail-value">{{ company.annualRevenue }}</span>
                </div>
                <div class="detail-row" *ngIf="company.employees">
                  <span class="detail-label">Empleados:</span>
                  <span class="detail-value">{{ company.employees }}</span>
                </div>
                <div class="detail-row">
                  <span class="detail-label">Sector:</span>
                  <span class="detail-value">{{ company.sector }}</span>
                </div>
                <div class="detail-row">
                  <span class="detail-label">Tecnolog√≠as:</span>
                  <div class="tech-tags">
                    <span 
                      *ngFor="let tech of company.technologies.slice(0, 3)"
                      class="tech-tag"
                    >
                      {{ tech }}
                    </span>
                    <span 
                      *ngIf="company.technologies.length > 3"
                      class="tech-tag-more"
                    >
                      +{{ company.technologies.length - 3 }}
                    </span>
                  </div>
                </div>
              </div>

              <div class="company-footer mt-auto">
                <app-button 
                  variant="secondary" 
                  (clickEvent)="viewRFPs(company); $event.stopPropagation()"
                  class="action-btn"
                >
                  Ver Necesidades ({{ company.rfpCount || 0 }})
                </app-button>
                
                <div class="proposal-action-wrapper">
                  <app-button 
                    variant="primary" 
                    (clickEvent)="toggleProposalDropdown(company); $event.stopPropagation()"
                    class="action-btn"
                  >
                    Enviar Propuesta
                  </app-button>
                  
                  <!-- Proposal Dropdown -->
                  <div 
                    *ngIf="activeProposalCompanyId === company.id" 
                    class="proposal-dropdown"
                    (click)="$event.stopPropagation()"
                  >
                    <div class="dropdown-header">
                      <h4>Enviar Propuesta a {{ company.name }}</h4>
                      <button class="close-btn" (click)="toggleProposalDropdown(company)">√ó</button>
                    </div>
                    
                    <div class="dropdown-content">
                      <label>Selecciona tu Caso de Uso</label>
                      <select [(ngModel)]="proposalData.useCase" class="dropdown-select">
                        <option value="">Selecciona un caso de uso...</option>
                        <option value="chatbot-onboarding">Chatbot Asistente Onboarding RRHH</option>
                        <option value="vision-artificial">Visi√≥n Artificial para Control Calidad</option>
                        <option value="prediccion-fraude">Predicci√≥n de Fraude Transaccional</option>
                      </select>
                      
                      <div class="proposal-stats" *ngIf="proposalData.useCase">
                        <div class="stat-item">
                          <span>Engagement:</span>
                          <strong>{{ proposalData.engagement }}</strong>
                        </div>
                        <div class="stat-item">
                          <span>Usuarios:</span>
                          <strong>{{ proposalData.users }}</strong>
                        </div>
                      </div>
                      
                      <app-button 
                        variant="primary" 
                        style="width: 100%"
                        (clickEvent)="submitProposal(company)"
                      >
                        ‚úâÔ∏è Enviar Ahora
                      </app-button>
                    </div>
                  </div>
                </div>
              </div>
            </app-card>
          </div>
        </div>

        <!-- Empty State -->
        <div *ngIf="filteredCompanies.length === 0" class="empty-state">
          <app-card>
            <div class="empty-content">
              <span class="empty-icon">üè¢</span>
              <h2>No se encontraron empresas</h2>
              <p>Intenta ajustar los filtros de b√∫squeda</p>
            </div>
          </app-card>
        </div>
      </div>

      <!-- Use Cases Tab -->
      <div *ngIf="activeTab === 'use-cases'" class="tab-content">
        <div class="content-header">
          <div>
            <h1>CASOS DE USO</h1>
            <p class="results-count">{{ useCases.length }} resultados encontrados</p>
          </div>
          <div class="header-actions">
            <div class="sort-controls">
              <span>Ordenar por:</span>
              <select class="sort-select">
                <option>M√°s relevantes</option>
                <option>M√°s recientes</option>
                <option>Mejor valorados</option>
              </select>
            </div>
            <app-button 
              variant="primary" 
              (clickEvent)="createNewUseCase()"
              class="create-case-btn"
            >
              ‚ûï Crear Nuevo Caso
            </app-button>
          </div>
        </div>
        
        <div class="companies-grid">
          <div 
            *ngFor="let case of useCases"
            class="company-card use-case-card-wrapper"
            (click)="editUseCase(case)"
          >
            <app-card class="use-case-card">
              <!-- Case Image -->
              <div class="company-image use-case-image">
                <img [src]="case.image" [alt]="case.title" />
                <div class="image-overlay"></div>
                <div class="relevance-badge-container">
                   <span class="innovation-badge high">Relevancia {{ case.relevanceScore }}%</span>
                </div>
              </div>

              <div class="company-header use-case-header">
                <div class="provider-info">
                  <!-- Handle Logo: Check if it's a path or emoji/text -->
                  <div class="company-logo-sm" *ngIf="isImageLogo(case.provider.logo)">
                    <img [src]="case.provider.logo" [alt]="case.provider.name" />
                  </div>
                  <div class="company-logo-text" *ngIf="!isImageLogo(case.provider.logo)">
                    {{ case.provider.logo }}
                  </div>
                  <div class="provider-name">{{ case.provider.name }}</div>
                  <i class="pi pi-check-circle verified-icon" *ngIf="case.provider.verified" pTooltip="Verificado"></i>
                </div>
                <h3 class="use-case-title">{{ case.title }}</h3>
              </div>

              <div class="company-details use-case-details">
                <div class="kpis-container">
                  <div *ngFor="let kpi of case.kpis" class="kpi-item">
                    <span class="kpi-label">{{ kpi.label }}</span>
                    <span class="kpi-value">{{ kpi.value }}</span>
                  </div>
                </div>
                
                <div class="tech-tags">
                  <span *ngFor="let tag of case.tags" class="tech-tag">{{ tag }}</span>
                </div>
              </div>

              <div class="company-footer use-case-footer">
                <app-button variant="primary" style="width: 100%">Editar Caso</app-button>
              </div>
            </app-card>
          </div>
        </div>
      </div>

      <!-- RFPs Tab -->
      <div *ngIf="activeTab === 'rfps'" class="tab-content">
        <div class="content-header">
          <h1>DEMANDAS (RFPs)</h1>
        </div>
        <app-card>
          <div class="empty-content">
            <span class="empty-icon">üìã</span>
            <h2>RFPs en construcci√≥n</h2>
            <p>Pr√≥ximamente podr√°s ver y responder a RFPs publicados por empresas</p>
          </div>
        </app-card>
      </div>
    </main>
  </div>
</div>
