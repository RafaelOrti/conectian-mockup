<div class="admin-users">
  <p-toast></p-toast>
  <p-confirmDialog></p-confirmDialog>
  
  <app-navbar 
    userRole="ADMIN"
    userName="Admin User"
    [notificationCount]="3"
  ></app-navbar>

  <div class="container">
    <!-- Page Header -->
    <div class="page-header mb-4">
      <div>
        <h1 class="page-title">
          <i class="pi pi-users mr-2"></i>
          Usuarios
        </h1>
        <p class="page-subtitle">Gestión de CEOs y Proveedores</p>
      </div>
      <div class="header-actions">
        <p-button label="Export CSV" icon="pi pi-download" styleClass="p-button-outlined" (click)="exportCSV()"></p-button>
        <p-button label="+ Invite CEO" icon="pi pi-user-plus" (click)="inviteUser('ceo')"></p-button>
      </div>
    </div>

    <!-- Tabs -->
    <p-tabView [(activeIndex)]="activeTab">
      <!-- CEOs Tab -->
      <p-tabPanel header="CEOs" leftIcon="pi pi-users">
        <ng-template pTemplate="header">
          <div class="flex align-items-center gap-2">
            <i class="pi pi-users"></i>
            <span>CEOs</span>
            <p-badge [value]="ceoStats.total" styleClass="ml-2"></p-badge>
          </div>
        </ng-template>

        <!-- Stats Cards -->
        <div class="grid mb-4">
          <div class="col-12 md:col-3">
            <p-card styleClass="stat-card">
              <div class="stat-content">
                <div class="stat-value">{{ceoStats.total}}</div>
                <div class="stat-label">Mostra total</div>
              </div>
            </p-card>
          </div>
          <div class="col-12 md:col-3">
            <p-card styleClass="stat-card">
              <div class="stat-content">
                <div class="stat-value">{{ceoStats.free}}</div>
                <div class="stat-label">Free</div>
              </div>
            </p-card>
          </div>
          <div class="col-12 md:col-3">
            <p-card styleClass="stat-card">
              <div class="stat-content">
                <div class="stat-value">{{ceoStats.pro}}</div>
                <div class="stat-label">PRO IA</div>
              </div>
            </p-card>
          </div>
          <div class="col-12 md:col-3">
            <p-card styleClass="stat-card">
              <div class="stat-content">
                <div class="stat-value">{{ceoStats.active}}</div>
                <div class="stat-label">Active</div>
              </div>
            </p-card>
          </div>
        </div>

        <!-- Table -->
        <p-card>
          <ng-template pTemplate="header">
            <div class="table-header">
              <div class="flex gap-2">
                <span class="p-input-icon-left">
                  <i class="pi pi-search"></i>
                  <input pInputText type="text" [(ngModel)]="searchQuery" placeholder="Buscar CEOs..." (input)="onGlobalFilter(dt1, $event)" />
                </span>
                <p-dropdown [options]="statusOptions" [(ngModel)]="selectedStatus" optionLabel="label" placeholder="Estado"></p-dropdown>
                <p-button icon="pi pi-filter-slash" styleClass="p-button-text" pTooltip="Limpiar filtros"></p-button>
              </div>
            </div>
          </ng-template>
          
          <p-table 
            #dt1
            [value]="ceos" 
            [globalFilterFields]="['email','company','plan']"
            [(selection)]="selectedUsers"
            [paginator]="true" 
            [rows]="10"
            [rowsPerPageOptions]="[5, 10, 25]"
            [showCurrentPageReport]="true"
            currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords} CEOs"
            styleClass="p-datatable-gridlines">
            <ng-template pTemplate="header">
              <tr>
                <th style="width: 3rem">
                  <p-tableHeaderCheckbox></p-tableHeaderCheckbox>
                </th>
                <th pSortableColumn="email">
                  EMAIL <p-sortIcon field="email"></p-sortIcon>
                </th>
                <th pSortableColumn="plan">
                  PLAN <p-sortIcon field="plan"></p-sortIcon>
                </th>
                <th pSortableColumn="active">
                  ACTIVE <p-sortIcon field="active"></p-sortIcon>
                </th>
                <th>JOINED</th>
                <th>ACTIONS</th>
              </tr>
            </ng-template>
            <ng-template pTemplate="body" let-user>
              <tr>
                <td>
                  <p-tableCheckbox [value]="user"></p-tableCheckbox>
                </td>
                <td>
                  <div>
                    <div class="font-bold">{{ user.email }}</div>
                    <div class="text-sm text-gray-400" *ngIf="user.company">{{ user.company }}</div>
                  </div>
                </td>
                <td>
                  <p-tag [value]="user.plan" [severity]="getPlanSeverity(user.plan)"></p-tag>
                  <div class="text-xs text-gray-400" *ngIf="user.planPrice">{{ user.planPrice }}</div>
                </td>
                <td>
                  <p-tag 
                    [value]="user.active ? 'Hace ' + user.lastActive : '30d'" 
                    [severity]="user.active ? 'success' : 'danger'"
                    [icon]="user.active ? 'pi pi-check' : 'pi pi-times'"
                  ></p-tag>
                </td>
                <td>{{ user.joined }}</td>
                <td>
                  <div class="flex gap-1">
                    <p-button icon="pi pi-eye" styleClass="p-button-rounded p-button-text" pTooltip="Ver"></p-button>
                    <p-button icon="pi pi-pencil" styleClass="p-button-rounded p-button-text" pTooltip="Editar" (click)="editUser(user)"></p-button>
                    <p-button icon="pi pi-ban" styleClass="p-button-rounded p-button-text p-button-warning" pTooltip="Suspender" (click)="suspendUser(user)"></p-button>
                  </div>
                </td>
              </tr>
            </ng-template>
          </p-table>
        </p-card>
      </p-tabPanel>

      <!-- Providers Tab -->
      <p-tabPanel header="Proveedores" leftIcon="pi pi-briefcase">
        <ng-template pTemplate="header">
          <div class="flex align-items-center gap-2">
            <i class="pi pi-briefcase"></i>
            <span>Proveedores</span>
            <p-badge [value]="providerStats.total" styleClass="ml-2"></p-badge>
          </div>
        </ng-template>

        <!-- Stats Cards -->
        <div class="grid mb-4">
          <div class="col-12 md:col-3">
            <p-card styleClass="stat-card">
              <div class="stat-content">
                <div class="stat-value">{{providerStats.total}}</div>
                <div class="stat-label">Total</div>
              </div>
            </p-card>
          </div>
          <div class="col-12 md:col-3">
            <p-card styleClass="stat-card">
              <div class="stat-content">
                <div class="stat-value">{{providerStats.active}}</div>
                <div class="stat-label">Activos</div>
              </div>
            </p-card>
          </div>
          <div class="col-12 md:col-3">
            <p-card styleClass="stat-card">
              <div class="stat-content">
                <div class="stat-value">{{providerStats.pending}}</div>
                <div class="stat-label">Pendientes</div>
              </div>
            </p-card>
          </div>
          <div class="col-12 md:col-3">
            <p-card styleClass="stat-card">
              <div class="stat-content">
                <div class="stat-value">€{{providerStats.mrr.toLocaleString('es-ES')}}</div>
                <div class="stat-label">MRR</div>
              </div>
            </p-card>
          </div>
        </div>

        <!-- Table similar to CEOs -->
        <p-card>
          <ng-template pTemplate="header">
            <div class="table-header">
              <div class="flex gap-2">
                <span class="p-input-icon-left">
                  <i class="pi pi-search"></i>
                  <input pInputText type="text" placeholder="Buscar proveedores..." (input)="onGlobalFilter(dt2, $event)" />
                </span>
              </div>
            </div>
          </ng-template>
          
          <p-table 
            #dt2
            [value]="providers" 
            [paginator]="true" 
            [rows]="10"
            styleClass="p-datatable-gridlines">
            <ng-template pTemplate="header">
              <tr>
                <th>EMAIL</th>
                <th>PLAN</th>
                <th>ESTADO</th>
                <th>ACCIONES</th>
              </tr>
            </ng-template>
            <ng-template pTemplate="body" let-provider>
              <tr>
                <td>
                  <div class="font-bold">{{ provider.email }}</div>
                  <div class="text-sm text-gray-400">{{ provider.company }}</div>
                </td>
                <td>
                  <p-tag [value]="provider.plan" [severity]="getPlanSeverity(provider.plan)"></p-tag>
                </td>
                <td>
                  <p-tag [value]="provider.status?.toUpperCase() || 'N/A'" [severity]="getStatusSeverity(provider.status || '')"></p-tag>
                </td>
                <td>
                  <div class="flex gap-1">
                    <p-button icon="pi pi-eye" styleClass="p-button-rounded p-button-text"></p-button>
                    <p-button icon="pi pi-pencil" styleClass="p-button-rounded p-button-text" (click)="editUser(provider)"></p-button>
                  </div>
                </td>
              </tr>
            </ng-template>
          </p-table>
        </p-card>
      </p-tabPanel>

      <!-- Pending Approvals Tab -->
      <p-tabPanel header="Pendientes de Aprobación">
        <ng-template pTemplate="header">
          <div class="flex align-items-center gap-2">
            <i class="pi pi-clock"></i>
            <span>Pendientes de Aprobación</span>
            <p-badge [value]="pendingApprovals.length" severity="warning" styleClass="ml-2"></p-badge>
          </div>
        </ng-template>

        <p-card>
          <p-table [value]="pendingApprovals" styleClass="p-datatable-gridlines">
            <ng-template pTemplate="header">
              <tr>
                <th>PROVEEDOR</th>
                <th>PLAN</th>
                <th>FECHA</th>
                <th>ACCIONES</th>
              </tr>
            </ng-template>
            <ng-template pTemplate="body" let-provider>
              <tr>
                <td>
                  <div class="font-bold">{{ provider.email }}</div>
                  <div class="text-sm text-gray-400">{{ provider.company }}</div>
                </td>
                <td>
                  <p-tag [value]="provider.plan"></p-tag>
                </td>
                <td>{{ provider.joined }}</td>
                <td>
                  <div class="flex gap-2">
                    <p-button label="Aprobar" icon="pi pi-check" styleClass="p-button-success p-button-sm" (click)="approveProvider(provider)"></p-button>
                    <p-button label="Rechazar" icon="pi pi-times" styleClass="p-button-danger p-button-sm" (click)="rejectProvider(provider)"></p-button>
                  </div>
                </td>
              </tr>
            </ng-template>
          </p-table>
        </p-card>
      </p-tabPanel>
    </p-tabView>
  </div>
</div>
