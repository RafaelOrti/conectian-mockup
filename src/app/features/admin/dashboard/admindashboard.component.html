<div class="admin-dashboard">
  <app-navbar 
    userRole="ADMIN"
    userName="Admin User"
    [notificationCount]="3"
  ></app-navbar>

  <div class="container">
    <!-- Page Header -->
    <div class="page-header mb-4">
      <div>
        <h1 class="page-title">Dashboard</h1>
        <p class="page-subtitle">Panel de control administrativo</p>
      </div>
      <p-dropdown 
        [options]="periodOptions" 
        [(ngModel)]="selectedPeriod" 
        optionLabel="label"
        placeholder="Selecciona período"
        styleClass="period-selector"
      ></p-dropdown>
    </div>

    <!-- KPIs Grid -->
    <div class="grid mb-4">
      <div class="col-12 md:col-6 lg:col-3">
        <p-card styleClass="kpi-card mrr-card">
          <div class="kpi-content">
            <div class="kpi-header">
              <span class="kpi-label">MRR</span>
              <p-tag 
                [value]="'+' + kpis.mrrGrowth + '%'" 
                severity="success"
                icon="pi pi-arrow-up"
              ></p-tag>
            </div>
            <div class="kpi-value">€{{kpis.mrr.toLocaleString('es-ES')}}</div>
            <small class="kpi-description">Ingresos recurrentes mensuales</small>
          </div>
        </p-card>
      </div>

      <div class="col-12 md:col-6 lg:col-3">
        <p-card styleClass="kpi-card users-card">
          <div class="kpi-content">
            <div class="kpi-header">
              <span class="kpi-label">USUARIOS</span>
              <p-tag 
                [value]="'+' + kpis.usersGrowth + '%'" 
                severity="info"
                icon="pi pi-arrow-up"
              ></p-tag>
            </div>
            <div class="kpi-value">{{kpis.totalUsers}}</div>
            <small class="kpi-description">Total usuarios activos</small>
          </div>
        </p-card>
      </div>

      <div class="col-12 md:col-6 lg:col-3">
        <p-card styleClass="kpi-card matches-card">
          <div class="kpi-content">
            <div class="kpi-header">
              <span class="kpi-label">MATCHES</span>
              <p-tag 
                [value]="'+' + kpis.matchesGrowth + '%'" 
                severity="success"
                icon="pi pi-arrow-up"
              ></p-tag>
            </div>
            <div class="kpi-value">{{kpis.matches}}</div>
            <small class="kpi-description">Matches este mes</small>
          </div>
        </p-card>
      </div>

      <div class="col-12 md:col-6 lg:col-3">
        <p-card styleClass="kpi-card churn-card">
          <div class="kpi-content">
            <div class="kpi-header">
              <span class="kpi-label">CHURN</span>
              <p-tag 
                [value]="kpis.churnChange + '%'" 
                [severity]="kpis.churnChange < 0 ? 'success' : 'warning'"
                [icon]="kpis.churnChange < 0 ? 'pi pi-arrow-down' : 'pi pi-arrow-up'"
              ></p-tag>
            </div>
            <div class="kpi-value" [style.color]="'#f59e0b'">{{kpis.churnRate}}%</div>
            <small class="kpi-description">Tasa de cancelación</small>
          </div>
        </p-card>
      </div>

      <div class="col-12 md:col-6 lg:col-3">
        <p-card styleClass="kpi-card nps-card">
          <div class="kpi-content">
            <div class="kpi-header">
              <span class="kpi-label">NPS</span>
              <p-tag 
                [value]="kpis.npsChange === 0 ? '0%' : '+' + kpis.npsChange + '%'" 
                severity="secondary"
                icon="pi pi-minus"
              ></p-tag>
            </div>
            <div class="kpi-value">{{kpis.nps}}</div>
            <small class="kpi-description">Net Promoter Score</small>
          </div>
        </p-card>
      </div>
    </div>

    <!-- Revenue Chart -->
    <div class="grid mb-4">
      <div class="col-12">
        <p-card>
          <ng-template pTemplate="header">
            <div class="card-header-custom">
              <div class="flex align-items-center gap-2">
                <i class="pi pi-chart-line text-primary text-xl"></i>
                <h3 class="m-0">Revenue (Últimos 30 días)</h3>
              </div>
              <span class="text-sm text-gray-400">(Gráfico linear MRR - Integrar Chart.js o similar)</span>
            </div>
          </ng-template>
          <div class="chart-container">
            <p-chart type="line" [data]="revenueChartData" [options]="revenueChartOptions" [style]="{'height': '300px'}"></p-chart>
          </div>
        </p-card>
      </div>
    </div>

    <!-- Alerts Section -->
    <div class="grid mb-4">
      <div class="col-12">
        <p-card>
          <ng-template pTemplate="header">
            <div class="card-header-custom">
              <div class="flex align-items-center gap-2">
                <i class="pi pi-exclamation-triangle text-warning text-xl"></i>
                <h3 class="m-0">Alerts</h3>
              </div>
            </div>
          </ng-template>
          <div class="alerts-container">
            <p-message 
              *ngFor="let alert of alerts" 
              [severity]="alert.severity" 
              [text]="alert.message"
              styleClass="w-full mb-2"
            >
              <ng-template pTemplate="message" let-message>
                <div class="flex justify-content-between align-items-center w-full">
                  <span>{{ alert.message }}</span>
                  <p-button 
                    *ngIf="alert.action" 
                    [label]="alert.action" 
                    styleClass="p-button-text p-button-sm" 
                    (click)="handleAlertAction(alert)"
                  ></p-button>
                </div>
              </ng-template>
            </p-message>
          </div>
        </p-card>
      </div>
    </div>

    <!-- Activity and Pending Cases -->
    <div class="grid">
      <div class="col-12 lg:col-6">
        <p-card>
          <ng-template pTemplate="header">
            <div class="card-header-custom">
              <div class="flex align-items-center gap-2">
                <i class="pi pi-history text-primary text-xl"></i>
                <h3 class="m-0">Actividad Reciente (Últimas 24h)</h3>
              </div>
              <p-button label="Ver todo" icon="pi pi-arrow-right" styleClass="p-button-text p-button-sm" (click)="viewActivityDetails(recentActivity[0])"></p-button>
            </div>
          </ng-template>
          <p-timeline [value]="recentActivity" align="left">
            <ng-template pTemplate="marker" let-activity>
              <span class="custom-marker">
                <i [class]="'pi ' + activity.icon"></i>
              </span>
            </ng-template>
            <ng-template pTemplate="content" let-activity>
              <div class="timeline-content">
                <div class="flex justify-content-between align-items-start mb-2">
                  <div class="font-bold">{{ activity.name }}</div>
                  <span class="text-xs text-gray-400">{{ activity.timestamp }}</span>
                </div>
                <div class="text-sm text-gray-400">{{ activity.action }}</div>
              </div>
            </ng-template>
          </p-timeline>
        </p-card>
      </div>

      <div class="col-12 lg:col-6">
        <p-card>
          <ng-template pTemplate="header">
            <div class="card-header-custom">
              <div class="flex align-items-center gap-2">
                <i class="pi pi-file text-primary text-xl"></i>
                <h3 class="m-0">Casos Pendientes de Aprobación</h3>
              </div>
              <p-badge [value]="pendingCases.length" severity="warning"></p-badge>
            </div>
          </ng-template>
          <p-table [value]="pendingCases" [paginator]="true" [rows]="5" styleClass="p-datatable-sm">
            <ng-template pTemplate="header">
              <tr>
                <th>TÍTULO</th>
                <th>ESTADO</th>
                <th>ACCIONES</th>
              </tr>
            </ng-template>
            <ng-template pTemplate="body" let-case>
              <tr>
                <td>
                  <div class="font-bold text-sm">{{ case.title }}</div>
                  <div class="text-xs text-gray-400">{{ case.submittedBy }} • {{ case.date }}</div>
                </td>
                <td>
                  <p-tag [value]="case.status.toUpperCase()" [severity]="getStatusSeverity(case.status)"></p-tag>
                </td>
                <td>
                  <div class="flex gap-1">
                    <p-button 
                      icon="pi pi-check" 
                      styleClass="p-button-rounded p-button-text p-button-success p-button-sm" 
                      pTooltip="Aprobar"
                      (click)="approveCase(case)"
                    ></p-button>
                    <p-button 
                      icon="pi pi-times" 
                      styleClass="p-button-rounded p-button-text p-button-danger p-button-sm" 
                      pTooltip="Rechazar"
                      (click)="rejectCase(case)"
                    ></p-button>
                  </div>
                </td>
              </tr>
            </ng-template>
          </p-table>
        </p-card>
      </div>
    </div>

    <!-- Quick Actions -->
    <div class="grid mt-4">
      <div class="col-12">
        <p-card>
          <ng-template pTemplate="header">
            <div class="card-header-custom">
              <h3 class="m-0">Acciones Rápidas</h3>
            </div>
          </ng-template>
          <div class="flex flex-wrap gap-2">
            <p-button label="Aprobar Proveedores" icon="pi pi-user-plus" styleClass="p-button-primary" (click)="navigateToApprovals()"></p-button>
            <p-button label="Review Casos Uso" icon="pi pi-file-edit" styleClass="p-button-primary" (click)="navigateToCases()"></p-button>
            <p-button label="Ver Churn Report" icon="pi pi-chart-bar" styleClass="p-button-outlined" (click)="navigateToChurnReport()"></p-button>
            <p-button label="Analytics Completo" icon="pi pi-chart-line" styleClass="p-button-outlined" (click)="navigateToAnalytics()"></p-button>
          </div>
        </p-card>
      </div>
    </div>
  </div>
</div>
