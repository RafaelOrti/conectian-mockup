<div class="admin-finance-page">
  <app-navbar 
    [userRole]="'ADMIN'" 
    [userName]="'Admin User'"
    [notificationCount]="5"
  ></app-navbar>
  
  <div class="container">
    <!-- Page Header -->
    <div class="page-header">
      <div>
        <h1>üí∞ Finanzas</h1>
        <p class="subtitle">Control financiero y m√©tricas de ingresos</p>
      </div>
      <div class="header-actions">
        <select class="period-select" [(ngModel)]="selectedPeriod">
          <option value="7d">√öltimos 7 d√≠as</option>
          <option value="30d">√öltimos 30 d√≠as</option>
          <option value="90d">√öltimos 90 d√≠as</option>
          <option value="year">Este a√±o</option>
        </select>
        <app-button variant="primary" icon="üìä">Exportar Reporte</app-button>
      </div>
    </div>

    <!-- KPIs Row -->
    <div class="kpis-row">
      <app-card class="kpi-card">
        <div class="kpi-icon revenue">üíµ</div>
        <div class="kpi-content">
          <span class="kpi-label">MRR Total</span>
          <span class="kpi-value">‚Ç¨{{metrics.mrr.toLocaleString()}}</span>
          <span class="kpi-trend positive">+{{metrics.mrrGrowth}}% vs mes anterior</span>
        </div>
      </app-card>

      <app-card class="kpi-card">
        <div class="kpi-icon arr">üìà</div>
        <div class="kpi-content">
          <span class="kpi-label">ARR Proyectado</span>
          <span class="kpi-value">‚Ç¨{{metrics.arr.toLocaleString()}}</span>
          <span class="kpi-trend positive">+{{metrics.arrGrowth}}% crecimiento</span>
        </div>
      </app-card>

      <app-card class="kpi-card">
        <div class="kpi-icon customers">üë•</div>
        <div class="kpi-content">
          <span class="kpi-label">Clientes de Pago</span>
          <span class="kpi-value">{{metrics.payingCustomers}}</span>
          <span class="kpi-trend positive">+{{metrics.newCustomersThisMonth}} este mes</span>
        </div>
      </app-card>

      <app-card class="kpi-card">
        <div class="kpi-icon ltv">üíé</div>
        <div class="kpi-content">
          <span class="kpi-label">LTV Promedio</span>
          <span class="kpi-value">‚Ç¨{{metrics.avgLtv.toLocaleString()}}</span>
          <span class="kpi-trend">CAC: ‚Ç¨{{metrics.cac}}</span>
        </div>
      </app-card>
    </div>

    <!-- Revenue Breakdown -->
    <div class="grid-2">
      <app-card class="revenue-breakdown">
        <h3>Desglose de Ingresos</h3>
        <div class="breakdown-list">
          <div class="breakdown-item">
            <div class="breakdown-info">
              <span class="breakdown-label">Suscripciones CEOs (PRO IA)</span>
              <span class="breakdown-value">‚Ç¨{{revenueBreakdown.ceoPro.toLocaleString()}}/mes</span>
            </div>
            <div class="breakdown-bar">
              <div class="bar-fill" [style.width.%]="(revenueBreakdown.ceoPro / metrics.mrr) * 100"></div>
            </div>
            <span class="breakdown-percent">{{((revenueBreakdown.ceoPro / metrics.mrr) * 100).toFixed(1)}}%</span>
          </div>

          <div class="breakdown-item">
            <div class="breakdown-info">
              <span class="breakdown-label">Suscripciones Proveedores (PRO)</span>
              <span class="breakdown-value">‚Ç¨{{revenueBreakdown.providerPro.toLocaleString()}}/mes</span>
            </div>
            <div class="breakdown-bar">
              <div class="bar-fill provider" [style.width.%]="(revenueBreakdown.providerPro / metrics.mrr) * 100"></div>
            </div>
            <span class="breakdown-percent">{{((revenueBreakdown.providerPro / metrics.mrr) * 100).toFixed(1)}}%</span>
          </div>

          <div class="breakdown-item">
            <div class="breakdown-info">
              <span class="breakdown-label">Suscripciones Proveedores (Base)</span>
              <span class="breakdown-value">‚Ç¨{{revenueBreakdown.providerBase.toLocaleString()}}/mes</span>
            </div>
            <div class="breakdown-bar">
              <div class="bar-fill base" [style.width.%]="(revenueBreakdown.providerBase / metrics.mrr) * 100"></div>
            </div>
            <span class="breakdown-percent">{{((revenueBreakdown.providerBase / metrics.mrr) * 100).toFixed(1)}}%</span>
          </div>

          <div class="breakdown-item">
            <div class="breakdown-info">
              <span class="breakdown-label">Comisiones por Transacciones</span>
              <span class="breakdown-value">‚Ç¨{{revenueBreakdown.commissions.toLocaleString()}}/mes</span>
            </div>
            <div class="breakdown-bar">
              <div class="bar-fill commission" [style.width.%]="(revenueBreakdown.commissions / metrics.mrr) * 100"></div>
            </div>
            <span class="breakdown-percent">{{((revenueBreakdown.commissions / metrics.mrr) * 100).toFixed(1)}}%</span>
          </div>
        </div>
      </app-card>

      <app-card class="churn-card">
        <h3>Retenci√≥n y Churn</h3>
        <div class="churn-metrics">
          <div class="churn-stat">
            <span class="stat-value positive">{{churnMetrics.retentionRate}}%</span>
            <span class="stat-label">Tasa de Retenci√≥n</span>
          </div>
          <div class="churn-stat">
            <span class="stat-value negative">{{churnMetrics.churnRate}}%</span>
            <span class="stat-label">Tasa de Churn</span>
          </div>
          <div class="churn-stat">
            <span class="stat-value">{{churnMetrics.churnedThisMonth}}</span>
            <span class="stat-label">Churns este mes</span>
          </div>
          <div class="churn-stat">
            <span class="stat-value negative">‚Ç¨{{churnMetrics.lostRevenue.toLocaleString()}}</span>
            <span class="stat-label">Ingresos Perdidos</span>
          </div>
        </div>

        <h4 class="mt-6">Usuarios en Riesgo</h4>
        <div class="at-risk-list">
          <div *ngFor="let user of atRiskUsers" class="at-risk-item">
            <div class="user-info">
              <span class="user-email">{{user.email}}</span>
              <span class="user-plan">{{user.plan}}</span>
            </div>
            <div class="risk-indicator" [class]="'risk-' + user.riskLevel">
              {{user.riskLevel === 'high' ? 'üî¥' : user.riskLevel === 'medium' ? 'üü°' : 'üü¢'}}
              {{user.daysInactive}} d√≠as inactivo
            </div>
            <app-button variant="secondary" size="small">Contactar</app-button>
          </div>
        </div>
      </app-card>
    </div>

    <!-- Recent Transactions -->
    <app-card class="transactions-card">
      <div class="card-header">
        <h3>Transacciones Recientes</h3>
        <app-button variant="secondary" size="small">Ver Todas</app-button>
      </div>
      <table class="transactions-table">
        <thead>
          <tr>
            <th>Fecha</th>
            <th>Usuario</th>
            <th>Tipo</th>
            <th>Descripci√≥n</th>
            <th>Monto</th>
            <th>Estado</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let tx of recentTransactions">
            <td>{{tx.date}}</td>
            <td>{{tx.user}}</td>
            <td>
              <span class="tx-type" [class]="'type-' + tx.type">
                {{tx.type === 'subscription' ? 'üìÖ' : tx.type === 'commission' ? 'üí±' : 'üí≥'}} {{tx.typeLabel}}
              </span>
            </td>
            <td>{{tx.description}}</td>
            <td class="tx-amount" [class.positive]="tx.amount > 0" [class.negative]="tx.amount < 0">
              {{tx.amount > 0 ? '+' : ''}}‚Ç¨{{tx.amount.toLocaleString()}}
            </td>
            <td>
              <span class="tx-status" [class]="'status-' + tx.status">
                {{tx.status === 'completed' ? '‚úÖ' : tx.status === 'pending' ? '‚è≥' : '‚ùå'}} {{tx.statusLabel}}
              </span>
            </td>
          </tr>
        </tbody>
      </table>
    </app-card>
  </div>
</div>
